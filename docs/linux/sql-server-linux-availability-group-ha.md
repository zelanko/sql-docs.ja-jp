---
title: SQL Server Always On 可用性グループ配置パターン |Microsoft Docs
ms.custom: sql-linux
ms.date: 10/16/2017
ms.prod: sql
ms.reviewer: ''
ms.technology: linux
ms.topic: conceptual
ms.assetid: edd75f68-dc62-4479-a596-57ce8ad632e5
author: MikeRayMSFT
ms.author: mikeray
manager: craigg
ms.openlocfilehash: 22178bb26309bba1529189e728bde3e5a26bab0e
ms.sourcegitcommit: 61381ef939415fe019285def9450d7583df1fed0
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/01/2018
ms.locfileid: "47798940"
---
# <a name="high-availability-and-data-protection-for-availability-group-configurations"></a>可用性グループの構成の高可用性とデータの保護

[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md-linuxonly](../includes/appliesto-ss-xxxx-xxxx-xxx-md-linuxonly.md)]

この記事では、Linux サーバー上の SQL Server Always On 可用性グループのサポートされる展開構成を表示します。 可用性グループは、高可用性とデータ保護をサポートします。 障害の自動検出、自動フェールオーバー、およびフェールオーバー後に、透過的な再接続は、高可用性を提供します。 同期されたレプリカは、データ保護を提供します。 

Windows Server フェールオーバー クラスター (WSFC)、高可用性のための一般的な構成を使用して 2 つの同期レプリカと 3 番目のサーバーまたはファイル共有クォーラムを提供します。 ファイル共有のミラーリング監視サーバーは、たとえば可用性グループ構成の同期の状態と、レプリカのロールを検証します。 この構成により、セカンダリ レプリカのフェールオーバー ターゲットは、最新のデータと可用性グループ構成の変更を選択します。 

WSFC は、可用性グループのレプリカと、ファイル共有のミラーリング監視サーバーの間のフェールオーバー調停の構成メタデータを同期します。 Wsfc 可用性グループがないときに、SQL Server インスタンスは、master データベースの構成メタデータを格納します。

たとえば、Linux クラスター上の可用性グループは`CLUSTER_TYPE = EXTERNAL`します。 WSFC フェールオーバーを判別することはありません。 ここで、構成メタデータが管理され、SQL Server インスタンスによって管理されます。 このクラスターでミラーリング監視サーバーがないために、構成の状態のメタデータを格納する 3 つ目の SQL Server インスタンスが必要です。 これら 3 つすべての SQL Server インスタンスは、クラスターの分散型のメタデータの記憶域を提供できます。 

クラスター マネージャーでは、SQL Server のインスタンスを可用性グループ内のクエリを実行でき、高可用性を維持するためにフェールオーバーを調整することができます。 Linux クラスターでは、Pacemaker は、クラスター マネージャーです。 

SQL Server 2017 CU 1 により、高可用性を持つ可用性グループの`CLUSTER_TYPE = EXTERNAL`の 2 つの同期レプリカと構成のみのレプリカ。 SQL Server Express edition を含む任意のエディションの SQL Server 2017 CU1 以降の構成のみのレプリカをホストできます。 構成のみのレプリカでは、master データベースに可用性グループに関する構成情報は保持しますが、可用性グループ内のユーザー データベースが含まれていません。 

## <a name="how-the-configuration-affects-default-resource-settings"></a>構成が既定のリソースの設定に与える影響

SQL Server 2017 で導入、`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT`クラスター リソース設定します。 この設定は、指定した数のセカンダリ レプリカの書き込みのプライマリ レプリカは、各トランザクションをコミットする前にログに記録するトランザクション データを保証します。 外部のクラスター マネージャーを使用するときに、この設定は高可用性とデータ保護の両方に影響します。 設定の既定値は、クラスター リソースの作成時に、アーキテクチャとは異なります。 SQL Server リソース エージェントをインストールするときに`mssql-server-ha`- と可用性グループのクラスター リソースの作成、クラスター マネージャーには、可用性が検出されたグループの構成とセット`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT`それに応じて。 

構成、リソース エージェントのパラメーターでサポートされている場合`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT`高可用性とデータ保護を提供する値に設定されます。 詳細については、次を参照してください。 [pacemaker の理解の SQL Server リソース エージェント](#pacemakerNotify)します。

次のセクションでは、クラスター リソースの既定の動作を説明します。 

高可用性、データ保護、および読み取りスケールの特定のビジネス要件を満たすために可用性グループの設計を選択します。

次の構成では、可用性グループの設計パターンと、各パターンの機能について説明します。 これらの設計パターンは、可用性グループに適用`CLUSTER_TYPE = EXTERNAL`の高可用性ソリューション。 

- **次の 3 つの同期レプリカ**
- **2 つの同期レプリカ**
- **2 つの同期レプリカと構成のみのレプリカ**

<a name="threeSynch"></a>

## <a name="three-synchronous-replicas"></a>次の 3 つの同期レプリカ

この構成は、次の 3 つの同期レプリカで構成されます。 既定では、高可用性とデータ保護を提供します。 読み取りスケールも提供できます。

![3 つのレプリカ][3]

次の 3 つの同期レプリカを可用性グループには、読み取りスケール、高可用性、およびデータ保護を提供できます。 次の表では、可用性の動作について説明します。 

| |読み取りスケール|高可用性 (& a) </br> データの保護 | データ保護
|:---|---|---|---
|`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT=`|0 |1<sup>*</sup>|2
|プライマリ停止 | 手動フェールオーバー。 データが失われる可能性があります。 新しいプライマリは R/w です |自動フェールオーバー。 新しいプライマリは R/w です |自動フェールオーバー。 前のプライマリが回復し、セカンダリとして可用性グループに参加するまでにも、新しいプライマリはユーザー トランザクションでご利用いただけません。 
|1 つのセカンダリ レプリカ停止  | R は、プライマリ/w です プライマリが失敗した場合のない自動フェールオーバー。 |R は、プライマリ/w です プライマリにも失敗した場合のない自動フェールオーバー。 | プライマリでは、ユーザー トランザクションで使用できません。 
<sup>*</sup> 既定値

<a name="twoSynch"></a>

## <a name="two-synchronous-replicas"></a>2 つの同期レプリカ

この構成では、データの保護を実現します。 その他の可用性グループ構成のような読み取りスケールを有効にすることできます。 2 つの同期レプリカの構成では、自動高可用性は提供されません。 

![2 つの同期レプリカ][1]

2 つの同期レプリカを可用性グループは、読み取りスケールとデータ保護を提供します。 次の表では、可用性の動作について説明します。 

| |読み取りスケール |データ保護
|:---|---|---
|`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT=`|0 <sup>*</sup>|1
|プライマリ停止 | 手動フェールオーバー。 データが失われる可能性があります。 新しいプライマリは R/w です| 自動フェールオーバー。 前のプライマリが回復し、セカンダリとして可用性グループに参加するまでにも、新しいプライマリはユーザー トランザクションでご利用いただけません。
|1 つのセカンダリ レプリカ停止  |プライマリは、データの損失に不安定な実行、読み取り/書き込みです。 |プライマリはセカンダリが復旧するまではユーザー トランザクションで使用できません。
<sup>*</sup> 既定値

>[!NOTE]
>上記のシナリオでは、SQL Server 2017 CU 1 より前の動作です。 

<a name = "configOnly"></a>

## <a name="two-synchronous-replicas-and-a-configuration-only-replica"></a>2 つの同期レプリカと構成のみのレプリカ

同期レプリカが 2 つ (以上) と構成のみのレプリカを可用性グループはデータ保護を提供し、高可用性を実現も可能性があります。 次の図は、このアーキテクチャを表します。

![構成のみの可用性グループ][2]

1. セカンダリ レプリカへのユーザー データの同期レプリケーション。 可用性グループ構成メタデータも含まれています。
2. 可用性グループ構成メタデータの同期レプリケーション。 ユーザー データは含まれません。

可用性グループの図では、プライマリ レプリカは、構成のみのレプリカとセカンダリ レプリカの両方に構成データをプッシュします。 セカンダリ レプリカでは、ユーザー データも受信します。 構成のみのレプリカは、ユーザー データを受信しません。 セカンダリ レプリカは同期可用性モードです。 構成のみのレプリカに可用性グループ - 可用性グループに関するメタデータのみのデータベースが含まれていません。 構成のみのレプリカで構成データが同期的にコミットします。

>[!NOTE]
>構成のみのレプリカ、availabilility グループは SQL Server 2017 CU1 の新機能です。 SQL Server 可用性グループ内のすべてのインスタンスは、SQL Server 2017 CU1 をする必要がありますまたはそれ以降。 

既定値`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT`は 0 です。 次の表では、可用性の動作について説明します。 

| |高可用性 (& a) </br> データの保護 | データ保護
|:---|---|---
|`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT=`|0 <sup>*</sup>|1
|プライマリ停止 | 自動フェールオーバー。 新しいプライマリは R/w です | 自動フェールオーバー。 新しいプライマリでは、ユーザー トランザクションで使用できません。 
|セカンダリ レプリカの停止 | プライマリでは、読み取り/書き込みを実行している公開データの損失 (プライマリが失敗し、復旧できない) 場合です。 プライマリにも失敗した場合のない自動フェールオーバー。 | プライマリでは、ユーザー トランザクションで使用できません。 プライマリにも失敗した場合にフェールオーバーするレプリカがありません。 
|構成のみのレプリカ停止 | R は、プライマリ/w です プライマリにも失敗した場合のない自動フェールオーバー。 | R は、プライマリ/w です プライマリにも失敗した場合のない自動フェールオーバー。 
|同期セカンダリ + の構成のみのレプリカの停止| プライマリでは、ユーザー トランザクションで使用できません。 自動フェールオーバーはありません。 | プライマリでは、ユーザー トランザクションで使用できません。 レプリカにフェールオーバーする場合はプライマリにも失敗しません。 
<sup>*</sup> 既定値

>[!NOTE]
>構成のみのレプリカをホストする SQL Server のインスタンスでは、他のデータベースもホストできます。 1 つ以上の可用性グループの構成専用のデータベースとして参加できます。 

## <a name="requirements"></a>要件

* 構成のみのレプリカを可用性グループ内のすべてのレプリカは、SQL Server 2017 CU 1 またはそれ以降である必要があります。
* SQL Server の任意のエディションでは、SQL Server Express を含む、構成専用レプリカをホストできます。 
* 可用性グループには、プライマリ レプリカだけでなく、少なくとも 1 つのセカンダリ レプリカが必要があります。
* 構成のみのレプリカは、SQL Server のインスタンスごとのレプリカの最大数にはカウントされません。 最大 3 つのレプリカ SQL Server standard edition、SQL Server Enterprise Edition が最大 9 を使用できます。

## <a name="considerations"></a>考慮事項

* 可用性グループごとの複数の構成のみのレプリカ。 
* 構成のみのレプリカは、プライマリ レプリカにすることはできません。
* 構成のみのレプリカの可用性モードを変更することはできません。 同期または非同期のセカンダリ レプリカには、構成のみのレプリカから変更するには、構成のみのレプリカを削除し、必要な可用性モードでのセカンダリ レプリカを追加します。 
* 構成のみのレプリカの可用性グループ メタデータと同期しています。 ユーザー データがありません。 
* 1 つのプライマリ レプリカと 1 つの構成のみのレプリカがないセカンダリ レプリカを可用性グループが無効です。 
* 可用性グループは、SQL Server Express edition のインスタンスを作成できません。 

<a name="pacemakerNotify"></a>

## <a name="understand-sql-server-resource-agent-for-pacemaker"></a>Pacemaker 用 SQL Server リソース エージェントを理解します。

SQL Server 2017 CTP 1.4 追加`sequence_number`に`sys.availability_groups`レプリカがプライマリ レプリカとはどのように最新の状態のセカンダリを識別するために Pacemaker を許可します。 `sequence_number` 最新であるか、ローカルの可用性グループのレプリカを表す、単調増加 BIGINT です。 Pacemaker の更新プログラム、`sequence_number`各可用性グループ構成の変更。 構成の変更の例には、フェールオーバー、レプリカの追加または削除が含まれます。 数が、プライマリ上で更新し、セカンダリ レプリカにレプリケートします。 このため最新の状態が構成されているセカンダリ レプリカは、プライマリと同じシーケンス番号です。 

まず送り Pacemaker は、プライマリ レプリカを昇格を決定したら、*昇格前*すべてのレプリカに通知します。 レプリカは、シーケンス番号を返します。 次に、Pacemaker は、実際にレプリカをプライマリに昇格しようとするときに、レプリカのみ昇格自体がシーケンス番号が最も高いすべてのシーケンス番号の場合。 独自のシーケンス番号が最大のシーケンス番号が一致しない場合、レプリカは、昇格操作を拒否します。 この方法により、最大のシーケンス番号を持つレプリカだけがプライマリに昇格できるようになるため、データの損失が回避されます。 

このプロセスでは、前のプライマリと同じシーケンス番号とプロモーションの利用可能な少なくとも 1 つのレプリカが必要です。 Pacemaker リソース エージェントのセット`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT`を少なくとも 1 つの同期セカンダリ レプリカが最新であり、既定では、自動フェールオーバーのターゲットにすることができます。 各監視アクションの値と`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT`計算 (および必要に応じて更新) です。 `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT`値が 2 で 'の同期レプリカの数' 割った値します。 フェールオーバー時に、リソース エージェントが必要です (`total number of replicas`  -  `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT`レプリカ) に応答する、昇格前通知します。 最高の値を持つレプリカ`sequence_number`がプライマリに昇格します。 

たとえば、次の 3 つの同期レプリカの 1 つのプライマリ レプリカと 2 つの同期セカンダリ レプリカを可用性グループ。

- `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` 1 になります。(3/2 -> 1)。

- 昇格前アクションに応答するレプリカの必要な数は 2 です。(3-1 = 2)。 

このシナリオでは、2 つのレプリカは、フェールオーバーをトリガーする応答する必要があります。 両方のセカンダリ レプリカをプライマリ レプリカの停止後に自動フェールオーバーを正常は、最新の状態にして、対応する必要があります、昇格前通知します。 Online と同期する場合は、同じシーケンス番号があります。 可用性グループでは、1 つ昇格させます。 セカンダリ レプリカの 1 つに応答するだけの場合、昇格前アクション、リソース エージェントが応答したセカンダリが最も高い得られずのフェールオーバーはトリガーされませんを保証できません。

>[!IMPORTANT]
>`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` が 0 の場合、データ損失のリスクがあります。 プライマリ レプリカの停止中に、リソース エージェントで自動的にフェールオーバーは発生しません。 プライマリを回復するまで待機するか、手動フェールオーバーを使用して行う`FORCE_FAILOVER_ALLOW_DATA_LOSS`します。

既定の動作をオーバーライドし、設定を可用性グループ リソースを防ぐことができます`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT`自動的にします。

次のスクリプト セット`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT`という名前の可用性グループに対して、0 に`<**ag1**>`します。 実行する前に、`<**ag1**>` を実際の可用性グループの名前に置き換えます。

```bash
sudo pcs resource update <**ag1**> required_synchronized_secondaries_to_commit=0
```

実行、可用性グループの構成に基づいて、既定値に戻す。

```bash
sudo pcs resource update <**ag1**> required_synchronized_secondaries_to_commit=
```

>[!NOTE]
>上記のコマンドを実行すると、プライマリは一時的に降格セカンダリ、再度昇格しました。 リソースの更新には、すべてのレプリカが停止して再起動が発生します。 新しい値`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT`、瞬時にないレプリカが再起動後にのみ設定します。

## <a name="see-also"></a>関連項目

[Linux 上の可用性グループ](sql-server-linux-availability-group-overview.md)

<!--Image references-->
[1]: ./media/sql-server-linux-availability-group-ha/1-read-scale-out.png
[2]: ./media/sql-server-linux-availability-group-ha/2-configuration-only.png
[3]: ./media/sql-server-linux-availability-group-ha/3-three-replica.png
[4]: ./media/sql-server-linux-availability-group-ha/configuration-only-example.png
