---
title: 高速データベース復旧 | Microsoft Docs
ms.date: 08/12/2019
ms.prod: sql
ms.prod_service: backup-restore
ms.technology: backup-restore
ms.topic: conceptual
helpviewer_keywords:
- accelerated database recovery [SQL Server], recovery-only
- database recovery [SQL Server]
author: mashamsft
ms.author: mathoma
ms.reviewer: kfarlee
monikerRange: '>=sql-server-ver15||=sqlallproducts-allversions'
ms.openlocfilehash: c7912e3048021255da0340f19f5d449d1c13a6c7
ms.sourcegitcommit: 792c7548e9a07b5cd166e0007d06f64241a161f8
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/19/2019
ms.locfileid: "75245293"
---
# <a name="accelerated-database-recovery"></a>高速データベース復旧

[!INCLUDE[tsql-appliesto-ss-xxxx-xxxx-xxx-md](../includes/tsql-appliesto-ss-xxxx-xxxx-xxx-md.md)]

高速データベース復旧 (ADR) では、SQL データベース エンジンの復旧プロセスの再設計により、データベースの可用性が向上します (実行時間の長いトランザクションが存在する場合は特に)。 ADR は SQL Server 2019 の新しい機能です。また、Azure SQL Database の単一データベースとプールされたデータベースや Azure SQL Data Warehouse (現在、プレビュー段階) のデータベースで利用できます。 ADR の主な利点:

- **高速かつ一貫性のあるデータベース復旧**

  ADR を利用すると、実行時間の長いトランザクションが全体的な復旧時間に影響を与えることがありません。システム内でアクティブになっているトランザクションの数やそのサイズに関係なく、高速かつ一貫性のあるデータベース復旧が可能になります。

- **トランザクションの瞬間的ロールバック**

  ADR を利用すると、トランザクションがアクティブになっていた時間や実行された更新プログラムの数に関係なく、トランザクションのロールバックが一瞬で完了します。

- **ログの積極的切り捨て**

  ADR を利用すると、トランザクション ログが積極的に切り捨てられます。この積極的な切り捨ては、実行時間の長いアクティブなトランザクションが存在しても行われ、制御不能になることを防止します。

## <a name="the-current-database-recovery-process"></a>現在のデータベース復旧プロセス

ADR を使用しない場合、SQL Server のデータベース復旧は [ARIES](https://people.eecs.berkeley.edu/~brewer/cs262/Aries.pdf) 復旧モデルに従い、次の図に示されている 3 つのフェーズで構成されます。詳細はこの図の下で説明されています。

![現在の復旧プロセス](./media/accelerated-database-recovery-concepts/current-recovery-process.png)

- **分析フェーズ**

  SQL Server では、最後に成功したチェックポイント (あるいは、最も古いダーティ ページ LSN) の初めから終わりまでトランザクション ログを前方スキャンし、SQL Server が停止した時刻における各トランザクションの状態を判断します。

- **再実行フェーズ**

  SQL Server では、コミットした最も古いトランザクションから終わりまでトランザクション ログを前方スキャンし、コミットした操作をすべてやり直すことで、データベースをクラッシュ時の状態にします。

- **元に戻すフェーズ**

  SQL Server では、クラッシュ時にアクティブになっていたトランザクションごとに、ログを逆方向に進み、そのトランザクションで実行された操作を元に戻します。

この設計に基づき、データベース エンジンが予想外の再起動から復旧するために必要な時間は、クラッシュ時のシステムで最も大きいアクティブ トランザクションのサイズに (おおよそ) 比例します。 復旧するには、不完全なトランザクションをすべてロールバックする必要があります。 必要となる時間の長さは、トランザクションによって実行された作業の量と、トランザクションがアクティブになっている時間の長さに比例します。 そのため、SQL Server の復旧プロセスでは、実行時間の長いトランザクション (大規模な一括挿入操作や、サイズの大きなテーブルに対するインデックス作成操作など) がある場合に、長時間を要することがあります。

また、この設計に基づき大規模なトランザクションをキャンセルするかロールバックするときも、時間がかかることがあります。前述のものと同じ "元に戻す" 復旧フェーズが利用されるためです。

さらに、データベース エンジンでは、実行時間の長いトランザクションが存在するとき、トランザクション ログを切り捨てることができません。それに対応するログ レコードが復旧プロセスやロールバック プロセスに必要になるためです。 結果として、一部のトランザクション ログが非常に大きくなり、大量のドライブ領域を占有します。

## <a name="the-accelerated-database-recovery-process"></a>高速データベース復旧プロセス

ADR では、データベース エンジン復旧プロセスを次のように再設計することで前述の問題に対処しています。

- 最も古いアクティブ トランザクションの先頭を基点にログをスキャンする必要性をなくすことで、所要時間を一定化し、高速化を実現しています。 ADR を利用することで、トランザクション ログの処理は、最後に成功したチェックポイント (あるいは、最も古いダーティ ページのログ シーケンス番号 (LSN)) からに限定されます。 そのため、実行時間の長いトランザクションによって復旧時間が影響を受けることはありません。
- トランザクション全体のログを処理する必要がなくなるので、必要なトランザクション ログ領域が最小限に抑えられます。 そのため、チェックポイントやバックアップごとにトランザクション ログを積極的に切り捨てることができます。

要するに、ADR では、物理的なデータベース変更をすべてバージョン管理し、論理的な操作だけを元に戻すようにすることで、処理の対象を減らし、瞬間的な処理を可能にして、高速なデータベース復旧を実現しているのです。 クラッシュ時にアクティブになっていたトランザクションがあれば、それには "中止" の印が付けられ、そのようなトランザクションによって生成されたバージョンは同時実行ユーザー クエリで無視されます。

ADR 復旧プロセスには、現行の復旧プロセスと同じく 3 つのフェーズがあります。 それらのフェーズと ADR が連動するしくみを示したものが次の図です。

![ADR の復旧プロセス](./media/accelerated-database-recovery-concepts/adr-recovery-process.png)

- **分析フェーズ**

  プロセスは現行のものと同じままで、sLog を再構築し、バージョン管理されない操作のログ レコードがコピーされるという作業が追加されます。
  
- **再実行**フェーズ

  2 つのサブフェーズに分割されます。
  - サブフェーズ 1

      sLog から再実行します (最も古い未コミット トランザクションから最後のチェックポイントまで)。 sLog から数個のレコードを処理するだけで済むので、再実行操作は迅速に完了します。

  - サブフェーズ 2

     トランザクション ログからの再実行は最後のチェックポイントから開始されます (最も古いコミット前のトランザクションではなく)
     
- **元に戻すフェーズ**

   ADR を利用した元に戻すフェーズは、sLog を利用してバージョン管理されない操作と永続的なバージョン ストア (PVS) を元に戻し、行レベルではバージョンに基づいて論理的に元に戻すことで、ほぼ一瞬で完了します。

## <a name="adr-recovery-components"></a>ADR 復旧コンポーネント

ADR には次の 4 つの主要コンポーネントがあります。

- **永続的なバージョン ストア (PVS)**

  永続的なバージョン ストアは、従来の `tempdb` バージョン ストアではなく、データベース自体で生成された行バージョンを永続化するためのデータベース エンジン メカニズムです。 PVS を使用すると、リソースの分離が可能になり、読み取り可能なセカンダリの可用性が向上します。

- **論理的に元に戻す**

  論理的に元に戻す操作は、行レベルでバージョンに基づいて元に戻す操作を担う非同期プロセスであり、バージョン管理されているすべての操作に関して、トランザクションを一瞬でロールバックし、元に戻します。

  - 中止となったトランザクションをすべて追跡記録する
  - すべてのユーザー トランザクションを対象に、PVS を使用してロールバックを実行する
  - トランザクション中止の直後、すべてのロックを解放する

- **sLog**

  sLog は、バージョン管理されない操作 (メタデータ キャッシュの無効化やロックの取得など) のログ レコードを格納するメモリ内ログ ストリームのセカンダリです。 sLog には次の特徴があります。

  - ボリュームが少なく、メモリ内に収められる
  - チェックポイント プロセス中にシリアル化され、ディスクに永続化される
  - トランザクションのコミットに合わせて定期的に切り捨てられる
  - バージョン管理されていない操作のみを処理することでやり直し操作と元に戻す操作を高速にする  
  - 必須のログ レコードのみを保持することでトランザクション ログの積極的な切り捨てを可能にする

- **クリーナー**

  クリーナーは、定期的に起動し、不要なページ バージョンを消去する非同期プロセスです。

## <a name="who-should-consider-accelerated-database-recovery"></a>データベース復旧の高速化を考慮すべきユーザー

次に当てはまるお客様は ADR の有効化を検討してください。

- 実行時間の長いトランザクションがワークロードに含まれるお客様。
- アクティブなトランザクションに起因し、トランザクション ログが大幅に増加したお客様。  
- (SQL Server が突然再起動したり、トランザクションを手動でロールバックしたりするなど) SQL Server の復旧時間が長く、データベースを長時間使用できなくなったことがあるお客様。


## <a name="see-also"></a>参照  

  
