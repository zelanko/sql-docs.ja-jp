---
title: SQL Server アップグレードのトレースを再生する
description: SQL Server アップグレードのために Database Experimentation Assistant を使用したトレースの再生
ms.custom: seo-lt-2019
ms.date: 12/12/2019
ms.prod: sql
ms.prod_service: dea
ms.suite: sql
ms.technology: dea
ms.tgt_pltfrm: ''
ms.topic: conceptual
author: HJToland3
ms.author: rajsell
ms.reviewer: mathoma
ms.openlocfilehash: 50f082edef5d9a6d4e95b7e37ef6d75f22eb6f2a
ms.sourcegitcommit: 792c7548e9a07b5cd166e0007d06f64241a161f8
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/19/2019
ms.locfileid: "75244867"
---
# <a name="replay-a-trace-in-database-experimentation-assistant"></a>Database Experimentation Assistant でトレースを再生する

Database Experimentation Assistant (DEA) では、アップグレードされたテスト環境に対してキャプチャされたトレースファイルを再生できます。 たとえば、SQL Server 2008 R2 で実行される実稼働ワークロードを考えてみます。 ワークロードのトレースファイルは、2回再生する必要があります。1回目は、運用環境で実行され、SQL Server 2016 などのアップグレードターゲット SQL Server バージョンを持つ環境で、同じバージョンの SQL Server を持つ環境で1回だけです。

> [!NOTE]
> トレースを再生するには、分散再生トレースを実行するようにバーチャルマシンまたは物理コンピュータを手動で設定する必要があります。 詳細については、「 [Configure 分散再生 for Database Experimentation Assistant](database-experimentation-assistant-configure-replay.md)」を参照してください。
>

## <a name="configure-a-trace-replay-for-target-1"></a>ターゲット1のトレース再生の構成

まず、既存の運用環境を表すターゲット1に対してトレースの再生を実行する必要があります。

1. DEA の左側のナビゲーションバーで矢印アイコンを選択し、[**すべての再生**] ページで [**新しい再生**] を選択します。

    ![DEA で再生を作成する](./media/database-experimentation-assistant-replay-trace/dea-create-replay.png)

    > [!NOTE]
    > 分散再生コントローラーコンピューターには、リモート接続に使用するユーザーアカウントに対するアクセス許可が必要です。

2. [**新しい再生**] ページの [**再生の詳細**] で、次の情報を入力または選択します。

    - **再生名**: トレース再生の名前を入力します。
    - [**ソーストレース形式**]: ソーストレースファイルの形式 (Trace または xevent) を指定します。
    - **ソースファイルへの完全パス**: ソーストレースファイルへの完全パスを指定します。 DReplay を使用する場合は、DReplay コントローラーとして機能するコンピューターにファイルが存在し、ユーザーアカウントがファイルとフォルダーへのアクセスを必要とします。
    - **再生ツール**: 再生ツール (dreplay または組み込み) を指定します。
    - **コントローラーコンピューター名**: 分散再生コントローラーとして機能するコンピューターの名前を指定します。
    - **再生トレースの場所**: トレースの再生に関連付けられているトレースファイル/xevent を格納するパスを指定します。

        > [!NOTE]
        > Azure SQL Database または Azure SQL Database マネージインスタンスの場合は、Azure blob ストレージアカウントの SAS URI を指定する必要があります。

3. **[はい、データベースを手動で復元しまし**た] チェックボックスをオンにして、データベースが復元されたことを確認します。

4. [ **SQL Server 接続の詳細**] で、次の情報を入力または選択します。

    - [**サーバーの種類**]: SQL server の種類 (**SqlServer**、 **AzureSqlDb**、 **AzureSqlManagedInstance**) を指定します。
    - **サーバー名**: SQL Server のサーバー名または IP アドレスを指定します。
    - **認証の種類**: [認証の種類] で [ **Windows**] を選択します。
    - **データベース名**: サーバー側のトレースを開始するデータベースの名前を入力します。 データベースを指定しない場合は、サーバー上のすべてのデータベースでトレースがキャプチャされます。

5. シナリオに応じて、[**接続を暗号化**し、**サーバー証明書を信頼**する] チェックボックスをオンまたはオフにします。

    ![[新しい再生] ページ](./media/database-experimentation-assistant-replay-trace/dea-new-replay.png)

## <a name="start-the-trace-replay-on-target-1"></a>ターゲット1でトレース再生を開始します

- 必要な情報を入力または選択したら、[**開始**] を選択してトレースの再生を開始します。

  入力した情報が有効な場合は、分散再生プロセスが開始されます。 そうしないと、正しくない情報を含むテキストボックスが赤色で強調表示されます。 入力した値が正しいことを確認し、[**開始**] を選択します。

  ![ターゲット1に対して進行状況を再生する](./media/database-experimentation-assistant-replay-trace/dea-run-replay-target1.png)

  必要に応じてプロセスを監視することができます。 再生が完了すると、DEA は、指定した場所にあるファイルに結果を格納します。

  ![ターゲット1に対する再生が完了しました](./media/database-experimentation-assistant-replay-trace/dea-replay-target1-complete.png)

## <a name="perform-the-trace-replay-against-target-2"></a>ターゲット2に対してトレースの再生を実行する

ターゲット1に対してトレースの再生を完了したら、目的のアップグレード環境を表す2番目のターゲットに対して同じ操作を行う必要があります。

1. この時点で、ターゲット2環境に関連付けられている詳細を使用して、トレース再生を構成します。
2. ターゲット2でトレースの再生を開始します。

   必要に応じてプロセスを監視することができます。 再生が完了すると、DEA は、指定した場所にあるファイルに結果を格納します。

## <a name="frequently-asked-questions-about-trace-replay"></a>トレースの再生に関してよく寄せられる質問

**Q: 対象サーバーで再生キャプチャを開始するには、どのようなセキュリティアクセス許可が必要ですか。**

- DEA アプリケーションでトレース操作を実行する Windows ユーザーには、SQL Server を実行しているターゲットコンピューターに対する sysadmin 権限が必要です。 これらのユーザー権限は、トレースを開始するために必要です。
- SQL Server を実行している対象コンピュータが実行されているサービスアカウントには、指定されたトレースファイルパスへの書き込みアクセス権が必要です。
- 分散再生クライアントサービスを実行するサービスアカウントは、SQL Server を実行している対象コンピューターに接続し、クエリを実行するためのユーザー権限を持っている必要があります。

**Q: 複数の再生を同じセッションで開始することはできますか。**

はい。複数の再生を開始し、同じセッションで完了するように追跡できます。

**Q: 複数の再生を並列で開始することはできますか。**

はい。ただし、[**コントローラーとクライアント**] で選択したのと同じコンピューターセットではありません。 コントローラーとクライアントがビジー状態になります。 並列再生を開始するには、**コントローラーとクライアント**の下に別のコンピューターセットを設定します。

**Q: 通常、再生が完了するまでにどれくらいの時間がかかりますか。**

通常、再生には、ソーストレースとソーストレースの前処理にかかる時間を足した時間がかかります。 ただし、コントローラーに登録されているクライアントコンピューターが、再生によって生成される負荷を管理するのに十分ではない場合、再生の完了に時間がかかることがあります。 コントローラーには、最大16台のクライアントコンピューターを登録できます。

**Q: ターゲットトレースファイルのサイズはどのくらいですか。**

ターゲットトレースファイルは、5 ~ 15 倍のソーストレースサイズにすることができます。 ファイルサイズは、実行されるクエリの数に基づいています。 たとえば、クエリプランの blob のサイズが大きい場合があります。 これらのクエリの統計が頻繁に変更されると、より多くのイベントがキャプチャされます。

**Q: データベースを復元する必要があるのはなぜですか。**

SQL Server は、ステートフルなリレーショナルデータベース管理システムです。 A/B テストを適切に実行するには、データベースの状態が常に保持されている必要があります。 そうしないと、再生中に運用環境に表示されないクエリのエラーが表示されることがあります。 これらのエラーを回避するには、ソースキャプチャの前にバックアップを実行することをお勧めします。 同様に、再生中のエラーを回避するには、SQL Server を実行しているターゲットコンピューターでバックアップを復元する必要があります。

**Q: 再生ページの "pass%" は何を意味していますか。**

**パス%** は、クエリの割合が渡されることを意味します。 エラーの数が予想されるかどうかを診断できます。 エラーが発生する可能性があります。または、データベースの整合性が失われたことが原因でエラーが発生する可能性があります。 **パス%** の値が予期したものと異なる場合は、トレースを停止し、SQL Profiler のトレースファイルを調べて、どのクエリが成功しなかったかを確認できます。

**Q: 再生中に収集されたトレースイベントを確認するにはどうすればよいですか。**

ターゲットトレースファイルを開き、SQL Profiler で表示します。 または、再生キャプチャを変更する場合、すべての SQL Server スクリプトは、C\\: Program Files (x86)\\Microsoft Corporation\\Database Experimentation Assistant\\scripts\\startreplaycapture. SQL で入手できます。

**Q: 再生中に収集されるトレースイベントにはどのようなものがありますか。**

DEA は、パフォーマンスに関連する情報を含むトレースイベントをキャプチャします。 キャプチャの構成は、StartReplayCaptureTrace スクリプトに含まれています。 これらのイベントは、 [sp_trace_setevent (transact-sql) リファレンスドキュメント](https://docs.microsoft.com/sql/relational-databases/system-stored-procedures/sp-trace-setevent-transact-sql)に記載されている一般的な SQL Server トレースイベントです。

## <a name="troubleshoot-trace-replay"></a>トレース再生のトラブルシューティング

**Q: SQL Server を実行しているコンピューターに接続できないのはなぜですか。**

- SQL Server を実行しているコンピューターの名前が有効であることを確認します。 確認するには、SQL Server Management Studio (SSMS) を使用してサーバーに接続してみてください。
- ファイアウォールの構成で SQL Server を実行しているコンピューターへの接続がブロックされていないことを確認します。
- ユーザーが必要なユーザー権限を持っていることを確認します。
- 分散再生クライアントのサービスアカウントに SQL Server を実行しているコンピューターへのアクセス権があることを確認します。

詳細については、% temp%\\dea のログを参照してください。 問題が解決しない場合は、製品チームにお問い合わせください。

**Q: 分散再生コントローラーに接続できないのはなぜですか。**

- コントローラーコンピューターで分散再生コントローラーサービスが実行されていることを確認してください。 確認するには、分散再生管理ツールを使用します`dreplay.exe status -f 1`(コマンドを実行します)。
- 再生がリモートで開始された場合:
  - DEA を実行しているコンピューターがコントローラーに対して ping を正常に実行できることを確認します。 [**再生環境の構成**] ページの指示に従って、ファイアウォールの設定によって接続が許可されていることを確認します。 詳細については、「 [SQL Server 分散再生](https://docs.microsoft.com/sql/tools/distributed-replay/sql-server-distributed-replay?view=sql-server-2017)」を参照してください。
  - 分散再生コントローラーのユーザーに対して、DCOM リモート起動とリモートアクティブ化が許可されていることを確認します。
  - 分散再生コントローラーのユーザーに対して、DCOM リモートアクセスユーザー権限が許可されていることを確認します。

**Q: トレースファイルのパスは、コンピューター上に存在します。分散再生コントローラーが見つからないのはなぜですか。**

分散再生は、ローカルディスクリソースにのみアクセスできます。 再生を開始する前に、ソーストレースファイルを分散再生コントローラーマシンにコピーする必要があります。 また、[**新しい再生**] ページでパスを指定する必要があります。

UNC パスは分散再生と互換性がありません。 分散再生パスは、最初のソーストレースファイル (拡張子を含む) へのローカルな絶対パスである必要があります。

**Q: 新しい再生ページでファイルを参照できないのはなぜですか。**

リモートコンピューター上のフォルダーを参照することはできないため、ファイルの参照は役に立ちません。 絶対パスをコピーして貼り付ける方が効率的です。

**Q: トレースで再生を開始しましたが、分散再生イベントは再生されませんでした。なぜでしょうか。**

この問題は、トレースファイルに再生可能なイベントがないか、イベントの再生方法に関する情報がに含まれていないことが原因で発生する可能性があります。 指定されたトレースファイルパスがソーストレースファイルを指しているかどうかを確認します。 ソーストレースファイルは、StartCaptureTrace スクリプトで指定された構成を使用して作成されます。

**Q: SQL Server 2017 分散再生コントローラーを使用してトレースファイルを前処理しようとすると、"予期しないエラーが発生しました" というメッセージが表示されます。なぜでしょうか。**

この問題は、SQL Server 2017 の RTM バージョンで知られています。 詳細については、「 [DReplay 機能を使用して SQL Server 2017 でキャプチャされたトレースを再生するときに予期しないエラー](https://support.microsoft.com/help/4045678/fix-unexpected-error-when-you-use-the-dreplay-feature-to-replay-a)」を参照してください。  
  
この問題は、SQL Server 2017 の最新の累積的な更新プログラム1で対処されています。 [SQL Server 2017 の累積的な更新プログラム 1](https://support.microsoft.com/help/4038634/cumulative-update-1-for-sql-server-2017)の最新バージョンをダウンロードします。

## <a name="see-also"></a>参照

- 提案された変更に関する洞察を得るために役立つ分析レポートを作成するには、「[レポートの作成](database-experimentation-assistant-create-report.md)」を参照してください。
