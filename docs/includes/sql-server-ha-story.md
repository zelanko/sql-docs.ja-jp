---
ms.openlocfilehash: 1394414db170826fa96ca51a5d35ff8dea199310
ms.sourcegitcommit: db9bed6214f9dca82dccb4ccd4a2417c62e4f1bd
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/25/2019
ms.locfileid: "68212309"
---
この記事では、SQL Server での高可用性とディザスター リカバリーのためのビジネス継続性ソリューションの概要を提供します。 

SQL Server を展開するすべての人が行う必要がある 1 つの共通タスクは、すべてのミッション クリティカルな SQL Server インスタンスとそれらに含まれるデータベースを、ビジネスおよびエンド ユーザーが必要とするときに (9 時から 5 時であろうと、24 時間であろうと) 使えるようにすることです。 目標は、最小限の中断または中断なく、ビジネスを継続させることです。 この概念は、ビジネス継続性とも呼ばれます。

SQL Server 2017 では、多くの新機能の導入と、既存機能への強化が行われ、そのいくつかは可用性に対するものです。 SQL Server 2017 の最大の補強は、Linux ディストリビューションでの SQL Server のサポートです。 SQL Server 2017 の新機能の完全なリストについては、「[SQL Server 2017 の新機能](https://docs.microsoft.com/sql/sql-server/what-s-new-in-sql-server-2017)」のトピックを参照してください。

この記事では、SQL Server 2017 の可用性シナリオと、SQL Server 2017 の新機能と強化された機能について重点的に取り上げます。 シナリオには、Windows Server と Linux の両方にまたがって SQL Server を展開できるハイブリッドなものと、データベースの読み取り可能なコピーの数を増やすことができるものが含まれます。 この記事では、SQL Server 以外の可用性オプション (仮想化によって提供されるものなど) については扱いませんが、ここで説明している内容はすべて、パブリック クラウド内であれ、オンプレミスのハイパーバイザー サーバーでホストされる場合であれ、ゲスト仮想マシン内での SQL Server のインストールに適用されます。

## <a name="sql-server-2017-scenarios-using-the-availability-features"></a>可用性機能を使用した SQL Server 2017 のシナリオ

可用性グループ、FCI、およびログ配布は、さまざまな方法で使用でき、必ずしも可用性を高めるためだけのものではありません。 可用性機能を使用できる 4 つの主な方法があります。

* 高可用性
* ディザスター リカバリー
* 移行とアップグレード
* 1 つ以上のデータベースの読み取り可能なコピーのスケール アウト

各セクションでは、その特定のシナリオに使用できる関連機能について説明します。 [SQL Server レプリケーション](https://docs.microsoft.com/sql/relational-databases/replication/sql-server-replication)の機能については、取り上げません。 これは Always On の傘下の可用性機能としては正式に指定されていませんが、特定のシナリオでデータに冗長性を持たせるためによく使用されます。 レプリケーションは、SQL Server on Linux の将来のリリースで追加される予定です。

> [!IMPORTANT] 
> SQL Server の可用性機能は、可用性ソリューションの最も基本的なビルディング ブロックである、堅牢で十分にテストされたバックアップと復元方法を持つという要件に取って代わるものではありません。

### <a name="high-availability"></a>高可用性

データ センターの局所またはクラウド領域内の 1 つの領域で問題が発生した場合に、SQL Server インスタンスまたはデータベースを使用できることを保証することが重要です。 このセクションでは、SQL Server の可用性機能がそのタスクでどのように役立つかを説明します。 記載されているすべての機能は、Windows Server と Linux の両方で使用できます。 

#### <a name="always-on-availability-groups"></a>Always On 可用性グループ

SQL Server 2012 で導入された、Always On 可用性グループ (可用性グループ) は、データベースの各トランザクションを、そのデータベースのコピーを含むレプリカと呼ばれる別のインスタンスに、特殊な状態で送信することによって、データベース レベルの保護を提供します。 可用性グループは、Standard Edition または Enterprise Edition に展開できます。  可用性グループに参加しているインスタンスは、スタンドアロンまたは Always On フェールオーバー クラスター インスタンス (FCI、次のセクションで説明) のいずれかにすることができます。 トランザクションは、発生したときにレプリカに送信されるため、回復ポイントの目標と復旧時間の目標の要件がより低い可用性グループが推奨されます。 レプリカ間のデータ移動は、同期または非同期で行うことができます。Enterprise Edition では、最大 3 つのレプリカ (プライマリを含む) を同期で行うことを許可しています。 可用性グループには、プライマリ レプリカにあるデータベースの完全な読み取り/書き込みコピーが 1 つありますが、すべてのセカンダリ レプリカはエンド ユーザーやアプリケーションから直接トランザクションを受け取れません。 

> [!NOTE] 
> Always On は、SQL Server での可用性機能の総称で、可用性グループと FCI の両方が含まれます。 Always On は、可用性グループ機能の名前ではありません。

可用性グループは、データベース レベルの保護のみを提供し、インスタンス レベルの保護は提供していないため、トランザクション ログにキャプチャされていないものや、データベースに構成されていないものはすべて、セカンダリ レプリカごとに手動で同期する必要があります。 手動で同期する必要があるオブジェクトの例としては、インスタンス レベル、リンク サーバー、および SQL Server エージェント ジョブでのログインがあります。

可用性グループには、リスナーと呼ばれる別のコンポーネントもあります。これは、プライマリ レプリカをホストしている SQL Server インスタンスがわからなくても、アプリケーションとエンド ユーザーが接続できるようにします。 各可用性グループには、独自のリスナーがあります。 リスナーの実装は、Windows Server と Linux ではわずかに異なりますが、提供される機能とその使用方法は同じです。 次の図は、Windows Server フェールオーバー クラスター (WSFC) を使用している Windows Server ベースの可用性グループを示しています。 OS レイヤーでの基になるクラスターは、Linux または Windows Server 上にあるかどうかに関係なく、可用性に必要です。 この例では、基になるクラスターが WSFC の単純な 2 つのサーバー (ノード) 構成を示しています。 

![単純な可用性グループ](media/sql-server-ha-story/image1.png)
 
レプリカに関しては、Standard Edition と Enterprise Edition で最大数が異なります。 Standard Edition の可用性グループ (基本的な可用性グループ ) は、可用性グループ内で 2 つのレプリカ (プライマリとセカンダリ) と 1 つのデータベースのみをサポートします。 Enterprise Edition は、1 つの可用性グループに複数のデータベースを構成できるだけでなく、最大 9 つのレプリカ (1 つのプライマリ、8 つのセカンダリ) を持つこともできます。 Enterprise Edition では、読み取り可能なセカンダリ レプリカ、セカンダリ レプリカからバックアップを作成するなど、その他の利点ももたらされます。

>[!NOTE]
> SQL Server 2012 で非推奨とされたデータベース ミラーリングは、Linux バージョンの SQL Server では使用できず、追加される予定もありません。 まだデータベース ミラーリングを使用しているお客様は、データベース ミラーリングの後継である可用性グループへの移行計画を開始する必要があります。

可用性に関しては、可用性グループは自動フェールオーバーまたは手動フェールオーバーを提供できます。 自動フェールオーバーは、同期データ移動が構成されていて、プライマリとセカンダリのレプリカ上のデータベースが同期状態にある場合に発生する可能性があります。 リスナーが使用され、アプリケーションが .NET (3.5 と更新、または 4.0) 以降を使用している限り、フェールオーバーは最小限に抑えて、リスナーが利用される場合にエンド ユーザーに影響が及ばないようにします。 セカンダリ レプリカを新しいプライマリ レプリカにするフェールオーバーは、自動または手動に構成でき、通常は数秒で測定されます。

次のリストは、Windows Server と Linux 上の可用性グループでのいくつかの違いを示しています。
* Linux と Windows Server での基になるクラスターの動作の違いにより、可用性グループのすべてのフェールオーバー (手動または自動) は、Linux 上のクラスターを介して行われます。 Windows Server ベースの可用性グループの展開では、SQL Server 経由での手動フェールオーバーを行う必要があります。 自動フェールオーバーは、Windows Server でも Linux でも基になるクラスターによって処理されます。 
* SQL Server 2017 では、Linux での可用性グループの構成は 3 つ以上のレプリカが推奨されます。 これは、基になるクラスタリングの動作方法に起因します。 2 つのレプリカの構成用に改善されたソリューションは、リリース後に提供されます。
* Linux では、各リスナーで使用される共通名は、Windows Server のようにクラスターではなく、DNS で定義されます。

SQL Server 2017 では、可用性グループに対して、次の新機能と機能強化が導入されています。

* クラスターの種類
* REQUIRED_SECONDARIES_TO_COMMIT
* Windows Server ベースの構成に対する Microsoft 分散トランザクション コーディネーター (DTC) サポートの強化
* 読み取り専用データベースに対するスケール アウト シナリオの追加 (この記事内で後ほど説明)

##### <a name="always-on-availability-group-cluster-types"></a>AlwaysOn 可用性グループのクラスターの種類

Windows Server でのクラスタリングの組み込みの可用性フォームは、フェールオーバー クラスタリングと呼ばれる機能を通じて有効化されます。 これにより可用性グループまたは FCI で使用される WSFC を構築できます。 可用性グループおよび FCI の統合は、SQL Server に同梱されているクラスター対応のリソース DLL で提供されます。 

サポートされている各 Linux ディストリビューションには、Pacemaker クラスター ソリューションの独自のバージョンが同梱されています。 SQL Server 2017 on Linux では、Pacemaker の使用をサポートしています。 Pacemaker は、各ディストリビューションが独自のスタックと統合できるオープン スタック ソリューションです。 Pacemaker はディストリビューションに同梱されていますが、Windows Server でのフェールオーバー クラスタリング機能ほどには統合されていません。

WSFC と Pacemaker は、違うものというよりも類似したものです。 どちらも個別のサーバーを使用してそれらを構成で結合し、可用性を提供する方法を提供し、リソース、制約 (異なる方法で実装されている場合でも)、フェールオーバーなどの概念を持っています。 可用性グループと自動フェールオーバーなどを含む FCI の構成の両方で Pacemaker をサポートするため、Microsoft では Pacemaker 用に mssql-server-ha パッケージを提供しています。これは、WSFC でのリソース DLL に似ていますが、まったく同じではありません。 WSFC と Pacemaker の違いの 1 つは、Pacemaker にはネットワーク名リソースがないことです。これは、WSFC でリスナーの名前 (または FCI の名前) を抽象化するのに役立つコンポーネントです。 DNS は、その名前解決を Linux 上で提供しています。

クラスター スタックの違いにより、可用性グループに対していくつか変更する必要があります。これは、WSFC によってネイティブで処理されるメタデータの一部を SQL Server が処理しなければならないからです。 最も[!IMPORTANT]な変更は、可用性グループに対するクラスターの種類の導入です。 これは、cluster_type 列と cluster_type_desc 列の sys.availability_groups に格納されます。 次の 3 つのクラスターの種類があります。

* WSFC 
* External
* なし

可用性を必要とするすべての可用性グループが、基になるクラスター (SQL Server 2017 の場合、WSFC または Pacemaker) を使用する必要があります。 基になる WSFC を使用する Windows Server ベースの可用性グループの場合、既定のクラスターの種類が WSFC なので設定する必要はありません。 Linux ベースの可用性グループの場合、可用性グループを作成するときに、クラスターの種類を External に設定する必要があります。 Pacemaker との統合は、可用性グループが作成された後に構成されますが、WSFC では作成時に行われます。

None のクラスターの種類は、Windows Server と Linux の可用性グループの両方で使用できます。 クラスターの種類を None に設定することは、可用性グループが基になるクラスターを必要としないことを意味します。 つまり、SQL Server 2017 は、クラスターなしで可用性グループをサポートする最初の SQL Server のバージョンですが、そのトレードオフとして、この構成が高可用性ソリューションとしてサポートされません。 

> [!IMPORTANT] 
> SQL Server 2017 では、可用性グループの作成後に、そのクラスターの種類を変更することはできません。 つまり、可用性グループを None から External または WSFC (またはその逆) に切り替えることはできません。 

データベースの読み取り専用コピーを追加することだけを検討しているユーザー、または移行やアップグレードを提供している可用性グループは欲しいが、基になるクラスターやレプリケーションにより複雑さが増すことを好まないユーザーにとっては、クラスターの種類が None の可用性グループが、最適なソリューションです。 詳しくは、「[移行とアップグレード](#Migrations)」と「[読み取りスケール](#ReadScaleOut)」のセクションをご覧ください。 

次のスクリーンショットは、SSMS での異なるクラスターの種類のサポートを示しています。 17.1 以降のバージョンを実行する必要があります。 次のスクリーンショットはバージョン 17.2 のものです。

![SSMS の可用性グループ オプション](media/sql-server-ha-story/image2.png)
 
##### <a name="requiredsynchronizedsecondariestocommit"></a>REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT

SQL Server 2016 では、Enterprise Edition でのサポートされる同期レプリカの数が 2 つから 3 つに増えました。 しかし、1 つのセカンダリ レプリカを同期したものの、他のレプリカで問題が発生した場合、動作を制御する方法がなく、プライマリ レプリカに誤動作しているレプリカを待機するか、先に進むかを指示できませんでした。 つまり、セカンダリ レプリカが同期されていない状態 (セカンダリ レプリカ上でデータの損失が発生している) でも、ある時点でプライマリ レプリカが書き込みトラフィックを受信し続けることになります。
SQL Server 2017 では、REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT という名前の同期レプリカがある場合に発生する動作を制御できるオプションが追加されました。 オプションの動作は次のとおりです。
* 指定可能な 3 つの値は次のとおりです。0、1、および 2
* 値は同期する必要があるセカンダリ レプリカの数で、データの損失、可用性グループの可用性、およびフェールオーバーに影響します。
* WSFC およびクラスターの種類 None の場合、既定値は 0 で、手動で 1 または 2 に設定することができます。
* クラスターの種類が External の場合、既定では、クラスター メカニズムによって値が設定され、手動でオーバーライドすることができます。 同期レプリカが 3 つの場合は、既定値は 1 になります。
Linux では、REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT の値は、クラスターの可用性グループ リソースで構成されます。 Windows では、Transact-SQL を通じて設定されます。

0 より大きい値は、より高いデータ保護を提供します。これは、必要な数のセカンダリ レプリカが使用できない場合、それが解決されるまでプライマリが使用できないからです。 セカンダリ レプリカの数が適切な状態でなかった場合、自動フェールオーバーが行われないため、REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT はフェールオーバーの動作にも影響します。 Linux では、値 0 は自動フェールオーバーを許可しないため、Linux では、自動フェールオーバーで同期を使用する場合は、自動フェールオーバーを実現するため 0 より大きい値を設定する必要があります。 Windows Server で値 0 は、SQL Server 2016 以前の動作です。

##### <a name="enhanced-microsoft-distributed-transaction-coordinator-support"></a>Microsoft 分散トランザクション コーディネーターのサポートの強化

SQL Server 2016 以前では、表面下の DTC を使用する分散トランザクションを必要とするアプリケーションの SQL Server での可用性を取得する唯一の方法は、FCI を展開することでした。 分散トランザクションは、次の 2 つのいずれかの方法で実行できます。
* 同じ SQL Server インスタンスで複数のデータベースにまたがるトランザクション
* 複数の SQL Server インスタンスにまたがる、または場合によっては SQL Server 以外のデータ ソースが関与するトランザクション

SQL Server 2016 では、後者のシナリオをカバーする可用性グループで DTC の部分的なサポートが導入されました。 SQL Server 2017 により、DTC を使用した両方のシナリオがサポートされるようになりました。

可用性グループに対する DTC のもう 1 つのサポート強化があります。SQL Server 2016 では、可用性グループに対する DTC のサポートを有効にできるのは、可用性グループが作成されたときだけで、後から追加することはできませんでした。 SQL Server 2017 では、可用性グループを作成した後でも DTC サポートを追加することができます。

>[!NOTE]
> DTC サポートは、Windows Server ベースの SQL Server インスタンス内のデータベースにのみ構成できます。 DTC がアプリケーションの要件である場合、SQL Server の展開に Windows Server を OS として使用する必要があります。Linux は使用できません。 

#### <a name="always-on-failover-cluster-instances"></a>Always On フェールオーバー クラスター インスタンス
クラスター化されたインストールは、SQL Server バージョン 6.5 以降の機能です。 FCI は、インスタンスと呼ばれる SQL Server のインストール全体の可用性を実現する実証済みの方法です。 データベース、SQL Server エージェント ジョブ、リンク サーバーなど、インスタンス内のすべてのものが別のサーバーに移動すると、基になるサーバーに問題が生じる可能性があります。 すべての FCI には、何らかの共有ストレージが必要です。ネットワーク経由で提供されるものでもかまいません。 FCI のリソースを実行および所有できるのは、一度に 1 つのノードのみです。 次の図は、FCI を所有するクラスターの最初のノードを示しています。これは、それに関連付けられた共有ストレージ リソースを所有 (ストレージへの実線で示されています) していることも意味します。

![フェールオーバー クラスター インスタンス](media/sql-server-ha-story/image3.png)
 
フェールオーバー後は、所有権は次の図にように変更されます。

![フェールオーバー後](media/sql-server-ha-story/image4.png)
 
FCI ではデータ損失は発生しませんが、データのコピーが 1 つ存在するため、基になる共有ストレージが単一障害点になります。 FCI は多くの場合、データベースの冗長コピーを持つために、可用性グループやログ配布などの別の可用性メソッドと組み合わされます。 展開される追加の方法では、FCI と物理的に分離したストレージを使用してください。 FCI が別のノードにフェールオーバーすると、1 つのノードで停止してから別のノードで開始します。サーバーの電源をオフにしてからオンにするのと似ています。 FCI は、通常の復旧プロセスを行います。つまり、ロール フォワードする必要があるすべてのトランザクションと、完了していないすべてのトランザクションがロールバックされます。 したがって、データベースは、データ ポイントから障害または手動フェールオーバーの時点まで整合性があるため、データ損失が生じません。 データベースは、復旧が完了しないと利用できないため、復旧時間はさまざまな要因によって異なり、通常は可用性グループのフェールオーバーよりも長くなります。 トレードオフとして、可用性グループをフェールオーバーするときに、SQL Server エージェント ジョブを有効にするなど、データベースを使用できるようにするために追加のタスクが必要になる場合があります。

可用性グループと同様に、FCI は基になるクラスターのどのノードによってホストされているかを抽象化します。 FCI は常に同じ名前を保持します。 アプリケーションとエンド ユーザーはノードに接続せず、FCI に割り当てられている一意の名前が使用されます。 FCI は、プライマリまたはセカンダリのいずれかのレプリカをホストしているインスタンスの 1 つとして、可用性グループに参加できます。

次のリストは、Windows Server と Linux 上の FCI でのいくつかの違いを示しています。

* Windows Server では、FCI はインストール プロセスの一部です。 Linux では、FCI は SQL Server のインストール後に構成されます。
* Linux は、ホストあたり 1 つの SQL Server のインストールしかサポートしないため、すべての FCI が既定のインスタンスになります。 Windows Server は、WSFC あたり最大 25 の FCI をサポートします。
* Linux で FCI によって使用される共通名は DNS で定義され、FCI 用に作成されたリソースと同じ名前である必要があります。

#### <a name="log-shipping"></a>ログ配布
復旧ポイントの目標と復旧時間の目標により柔軟性がある場合、またはデータベースが非常にミッション クリティカルであると見なされていない場合は、ログ配布が SQL Server におけるもう 1 つの実証済みの可用性機能となります。 SQL Server のネイティブ バックアップに基づき、ログ配布のプロセスによってトランザクション ログ バックアップが自動的に生成され、ウォーム スタンバイ状態であることが判明している 1 つ以上のインスタンスにコピーされ、そのスタンバイにトランザクション ログ バックアップが自動的に適用されます。 ログ配布は、SQL Server エージェント ジョブを使用して、バックアップ、コピー、およびトランザクション ログ バックアップの適用のプロセスを自動化します。

![ログ配布](media/sql-server-ha-story/image5.png)
 
ほぼ間違いなく、一部の容量でログ配布を使用する最大の利点は、ヒューマン エラーに対処することです。 トランザクション ログの適用が遅れる場合があります。 そのため、他のユーザーが WHERE 句なしで UPDATE のようなものを発行すると、スタンバイに変更されずに、プライマリ システムの修復中にスタンバイに切り替えることができます。 ログ配布は構成が容易ですが、プライマリからウォーム スタンバイ状態に切り替える (ロール切り替えと呼ばれます) のは常に手動です。 ロール切り替えは Transact-SQL を介して開始され、可用性グループと同様に、トランザクション ログにキャプチャされないすべてのオブジェクトを手動で同期する必要があります。 1 つの可用性グループには複数のデータベースを含めることができるのに対し、ログ配布はデータベースごとに構成する必要があります。 可用性グループや FCI とは異なり、ログ配布にはロール切り替えの抽象化がありません。 アプリケーションでこれを処理できる必要があります。 DNS エイリアス (CNAME) などの手法も使用できますが、切り替え後に DNS の更新に時間がかかるなど、良い点と悪い点があります。

## <a name="disaster-recovery"></a>ディザスター リカバリー

プライマリ可用性の場所で地震や洪水などの重大な事態が発生した場合、企業は自社のシステムを別の場所で稼働させるために準備する必要があります。 このセクションでは、SQL Server の可用性機能がビジネス継続性にどのように役立つことができるかを説明します。

### <a name="always-on-availability-groups"></a>Always On 可用性グループ

可用性グループの利点の 1 つは、高可用性とディザスター リカバリーの両方を 1 つの機能を使用して構成できることです。 共有ストレージも高可用性であることを確認することなく、高可用性のために 1 つのデータ センターにローカルのレプリカを持ち、ディザスター リカバリーのために他のデータ センターにリモートのレプリカをそれぞれ個別のストレージで持つ方がはるかに簡単です。 データベースの追加のコピーを持つことは、冗長性を確保するためのトレードオフです。 複数のデータ センターにまたがる可用性グループの例を次に示します。 1 つのプライマリ レプリカがすべてのセカンダリ レプリカの同期を維持する役割を担っています。

![可用性グループ](media/sql-server-ha-story/image6.png)
 
クラスターの種類が None の可用性グループ以外では、可用性グループは、すべてのレプリカが同じ基になるクラスターの一部である必要があります。WSFC または Pacemaker であるかどうかは関係ありません。 これは、上の図では、WSFC が 2 つの異なるデータ センターで機能するために拡張され、複雑さが増すことを意味します。 プラットフォーム (Windows Server または Linux) は関係ありません。 離れた距離でクラスターを拡張することで、複雑さが増します。 SQL Server 2016 で導入された分散型可用性グループにより、可用性グループは異なるクラスター上に構成されている可用性グループにまたがることができます。 これにより、すべてのノードを同じクラスターに参加させるという要件から解放され、ディザスター リカバリーの構成がはるかに容易になります。 分散型可用性グループの詳細については、「[分散型可用性グループ](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/distributed-availability-groups)」を参照してください。

![分散型可用性グループ](media/sql-server-ha-story/image11.png)
 
### <a name="always-on-failover-cluster-instances"></a>Always On フェールオーバー クラスター インスタンス

FCI はディザスター リカバリーに使用できます。 通常の可用性グループと同様に、基になるクラスター メカニズムをすべての場所に拡張する必要があり、複雑さが増します。 FCI には、共有ストレージという別の考慮事項があります。 同じディスクをプライマリとセカンダリ サイトで使用できる必要があるため、FCI によって使用されているディスクが別の場所に存在していることを確認するには、ハードウェア レイヤーでストレージ ベンダーによって提供される機能などの外部の方法や、Windows Server でストレージ レプリカを使用する必要があります。 

![Always On FCI](media/sql-server-ha-story/image8.png)
 
### <a name="log-shipping"></a>ログ配布
ログ配布は、SQL Server データベースにディザスター リカバリーを提供するための最も古い方法の 1 つです。 ログ配布は、他のオプションでは環境、管理者のスキルまたは予算により困難になる可能性がある場合に、コスト効果の高い、よりシンプルなディザスター リカバリーを提供するために、可用性グループおよび FCI と組み合わせて使用されることがよくあります。 ログ配布用の高可用性のシナリオと同様に、ヒューマン エラーに対処するため、多くの環境でトランザクション ログの読み込みに遅延が生じます。

## <a name = "Migrations"></a> 移行とアップグレード

新しいインスタンスを展開する場合、または古いインスタンスをアップグレードする場合に、ビジネスでは長時間の停止は許されません。 このセクションでは、SQL Server の機能を使用することで、計画的なアーキテクチャの変更、サーバーの切り替え、プラットフォームの変更 (Windows Server から Linux、またはその逆など)、または修正プログラムの適用時のダウンタイムをいかに最小限に抑えられるかについて説明します。

> [!NOTE]
> 移行とアップグレードでは、バックアップして他の場所でそれらを復元するなどの他の方法も使用できますが、 このドキュメントでは説明しません。 

### <a name="always-on-availability-groups"></a>Always On 可用性グループ

1 つ以上の可用性グループを含む既存のインスタンスは、SQL Server 2017 にインプレース アップグレードできます。 これにはある程度のダウンタイムが必要になりますが、適切に計画することで最小限に抑えることができます。 

目標が構成変更 (オペレーティング システムまたは SQL Server のバージョンを含む) ではなく、新しいサーバーへの移行の場合、これらのサーバーをノードとして既存の基になるクラスターに追加して、可用性グループに追加することができます。 レプリカが正しい状態になったら、新しいサーバーに手動フェールオーバーしてから、古いサーバーを可用性グループから削除し、最終的には使用停止にすることができます。 

分散型可用性グループは、新しい構成に移行または SQL Server をアップグレードするもう 1 つの方法でもあります。 分散型可用性グループは、異なるアーキテクチャ上でさまざまな基になる可用性グループをサポートするため、たとえば、Windows Server 2012 R2 上で実行されている SQL Server 2016 から Windows Server 2016 上で実行されている SQL Server 2017 に変更することができます。 

![分散型可用性グループ](media/sql-server-ha-story/image10.png)

最後に、クラスターの種類が None の可用性グループは、移行またはアップグレードにも使用できます。 一般的な可用性グループの構成では、クラスターの種類を混在させることはできないため、すべてのレプリカを None にする必要があります。 異なるクラスターの種類で構成された可用性グループにまたがるには、分散型可用性グループを使用できます。 この方法は異なる OS プラットフォームでもサポートされます。

移行とアップグレードのための可用性グループのすべてのバリエーションでは、最も時間のかかる作業の部分 (データの同期化) を徐々に実行できます。 新しい構成への切り替えを開始する場合、カットオーバーが短時間の停止であるのに対し、データの同期を含め、すべての作業が完了する必要がある場合は長時間のダウンタイムが発生します。 

可用性グループは、修正プログラムの適用が完了するまで、プライマリ レプリカからセカンダリ レプリカに手動でフェールオーバーすることで、基になる OS の修正プログラムの適用中のダウンタイムを最小限にできます。 オペレーティング システムの観点からは、元になる OS のサービスで (常にではありませんが) しばしば再起動が必要になることがあるため、Windows Server ではこれを行うのがより一般的です。 Linux の修正プログラムの適用には再起動が必要ですが、滅多に発生しません。 

[可用性グループに参加している SQL Server インスタンスに修正プログラムを適用](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/upgrading-always-on-availability-group-replica-instances)しても、可用性グループのアーキテクチャの複雑度によっては、ダウンタイムを最小限に抑えることができます。 可用性グループに参加しているサーバーに修正プログラムを適用するには、最初にセカンダリ レプリカに修正プログラムを適用します。 正しい数のレプリカに修正プログラムが適用されたら、プライマリ レプリカを別のノードに手動でフェールオーバーしてアップグレードを行います。 この時点で残りのすべてのセカンダリ レプリカもアップグレードできます。 

### <a name="always-on-failover-cluster-instances"></a>Always On フェールオーバー クラスター インスタンス

FCI 単独では従来の移行またはアップグレードを支援することはできません。可用性グループまたはログ配布を FCI 内のデータベースと構成する他のすべてのオブジェクト用に構成する必要があります。 ただし、基になる Windows Server に修正プログラムを適用する必要がある場合は、Windows Server の FCI がまだ一般的なオプションです。 手動フェールオーバーを開始できます。これは、Windows Server に修正プログラムが適用される間ずっとインスタンスを使用不可にする代わりに、短時間停止することを意味します。
FCI は、SQL Server 2017 にインプレース アップグレードできます。 詳細については、「[SQL Server フェールオーバー クラスター インスタンスのアップグレード](https://docs.microsoft.com/sql/sql-server/failover-clusters/windows/upgrade-a-sql-server-failover-cluster-instance)」を参照してください。

### <a name="log-shipping"></a>ログ配布

ログ配布は、データベースの移行とアップグレードの両方でいまだに一般的なオプションです。 可用性グループと似ていますが、今回はトランザクション ログを同期方法として使用します。データの伝達は、サーバーを切り替える前に十分な余裕をもって開始できます。 切り替え時に、ソースですべてのトラフィックが停止したら、最後のトランザクション ログを取得し、コピーし、新しい構成に適用する必要があります。 その時点で、データベースをオンラインにすることができます。 ログ配布は遅いネットワークに寛大なことが多く、可用性グループや分散型可用性グループを使用して行う切り替えよりも切り替えに若干時間がかかる場合がありますが、通常は数分で、数時間、数日、数週間かかるわけではありません。

可用性グループと同様に、ログ配布は修正プログラムの適用時に別のサーバーに切り替える方法を提供できます。

### <a name="other-sql-server-deployment-methods-and-availability"></a>その他の SQL Server の展開方法と可用性

SQL Server on Linux では、他に 2 つの展開方法があります。コンテナーと Azure (または別のパブリック クラウド プロバイダー) を使用することです。 このペーパーで示したように、SQL Server の展開方法に関係なく、可用性に対する一般的な必要性が存在します。 SQL Server を高可用性にするという点では、これら 2 つの方法にはいくつか特に注意が必要な点があります。

[Docker を使用したコンテナー](https://docs.microsoft.com/sql/linux/quickstart-install-connect-docker)は、Windows Server または Linux に SQL Server を展開する新しい方法です。 コンテナーとは、実行する準備ができている SQL Server の完全なイメージです。 ただし、現在は、クラスタリングのためのネイティブ サポートはないため、直接、高可用性またはディザスター リカバリーを管理します。 現時点では、コンテナーを使用して SQL Server データベースを使用可能にするためのオプションは、ログ配布およびバックアップと復元です。 前に述べたよう、クラスターの種類が None の可用性グループを構成できますが、真の可用性の構成とは見なされません。 Microsoft では、コンテナーを使用して可用性グループまたは FCI を有効にする方法を検討しています。 

現在コンテナーを使用していて、コンテナーが失われた場合、コンテナー プラットフォームによっては、もう一度展開して、使用していた共有ストレージにアタッチすることができます。 このメカニズムの一部は、コンテナー オーケストレーターによって提供されます。 これにより、ある程度の復元性が提供されますが、データベースの復旧に伴うある程度のダウンタイムが発生し、可用性グループまたは FCI を使用している場合ほどの真の高可用性は得られません。 

Linux の IaaS 仮想マシンは、Azure を使用してインストールされた SQL Server で展開できます。 オンプレミス ベースのインストールと同じく、サポートされているインストールでは、Pacemaker の外部にある STONITH (Shoot the Other Node in the Head) を使用する必要があります。 STONITH は、フェンス可用性エージェントを介して提供されます。 ディストリビューションによってはプラットフォームの一部として同梱しているものもありますが、それ以外は外部のハードウェアとソフトウェアのベンダーに依存しています。 サポートされているソリューションをパブリック クラウドに展開できるように、好みの Linux ディストリビューションでどのような STONITH が提供されているかを確認してください。

## <a name="cross-platform-and-linux-distribution-interoperability"></a>クロスプラットフォームおよび Linux ディストリビューションの相互運用性

SQL Server は、Windows Server と Linux の両方でサポートされるようになりました。このセクションでは、他の目的だけでなく、可用性のためにこれらを連携させる方法のシナリオに加え、複数の Linux ディストリビューションを取り入れたソリューションのシナリオについて説明します。

クロスプラットフォームと相互運用性のシナリオを説明する前に、2 つのファクトについて述べておく必要があります。

* WSFC ベースの FCI または可用性グループが Linux ベースの FCI または可用性グループと直接連動するシナリオはありません。 WSFC は Pacemaker ノードで拡張することはできません。その逆も同様です。 
* Linux ディストリビューションを混在させることは FCI または External のクラスターの種類を持つ可用性グループではサポートされていません。 そのシナリオでは、すべての可用性グループのレプリカに同じディストリビューションを構成するだけでなく、同じバージョンにする必要もあります。 SQL Server が 2 つのプラットフォーム間または複数の Linux のディストリビューションで動作できる 2 つのサポートされている方法は、可用性グループとログ配布です。

## <a name="distributed-availability-groups"></a>分散型可用性グループ 

分散型可用性グループは、可用性グループの構成にまたがることを目的としており、可用性グループの下のこれらの 2 つの基になるクラスターが 2 つの異なる WSFC、Linux ディストリビューション、または WSFC とその他の Linux 上のものかどうかは関係ありません。 分散型可用性グループは、クロスプラットフォーム ソリューションを持つ主要な手段になります。 分散型可用性グループは、Windows Server ベースの SQL Server インフラストラクチャから Linux ベースへの変換など、移行のための主要なソリューションでもあります (それが会社が指定するものである場合)。 前述のように、可用性グループ、特に分散型可用性グループは、アプリケーションが使用できない時間を最小限に抑えます。 WSFC と Pacemaker にまたがる分散型可用性グループの例を次に示します。

![分散型可用性グループ](media/sql-server-ha-story/image9.png)
 
可用性グループが None のクラスターの種類で構成されている場合は、Windows Server と Linux だけでなく複数の Linux ディストリビューションにまたがることができます。 これは、真の高可用性構成ではないため、ミッション クリティカルな展開には使用すべきではありませんが、読み取りスケールまたは移行/アップグレードのシナリオには使用できます。

## <a name="log-shipping"></a>ログ配布

ログ配布はバックアップと復元にのみ基づいているため、Windows Server の SQL Server と SQL Server on Linux では、データベース、ファイル構造などに違いはありません。 つまり、ログ配布は、Windows Server ベースの SQL Server のインストール間で構成でき、Linux ベースでも Linux のディストリビューション間でも構成できます。 それ以外はすべて同じです。 注意が必要な点は、可用性グループと同じように、ソースの SQL Server のメジャー バージョンが、ターゲットのバージョンよりも新しい場合には、ログ配布が機能しないことだけです。 

## <a name = "ReadScaleOut"></a>読み取りスケール

SQL Server 2012 で導入されて以来、セカンダリ レプリカは読み取り専用クエリに使用することができます。 可用性グループで実現できる 2 つの方法があります。セカンダリへの直接アクセスを許可することと、リスナーを使用する必要がある[読み取り専用のルーティングを構成する](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/configure-read-only-routing-for-an-availability-group-sql-server)ことです。  SQL Server 2016 で導入された、ラウンドロビン アルゴリズムを使用したリスナーを通じて読み取り専用の接続を負荷分散する機能により、読み取り専用の要求をすべての読み取り可能なレプリカに分散させることができます。 

> [!NOTE]
> 読み取り可能なセカンダリ レプリカは Enterprise Edition のみの機能で、読み取り可能なレプリカをホストする各インスタンスには、SQL Server ライセンスが必要です。

可用性グループを使用してデータベースの読み取り可能なコピーを拡張することは、 SQL Server 2016 の分散型可用性グループで初めて導入されました。 これにより企業は、最小限の構成でデータベースの読み取り専用のコピーをローカルだけでなく、地域およびグローバルで持つことができ、クエリがローカルで実行されることでネットワーク トラフィックと遅延を削減することができます。 可用性グループの各プライマリ レプリカは、完全に読み書き可能なコピーでなくても、他の 2 つの可用性グループをシードできるため、各分散型可用性グループは読み取り可能なデータのコピーを最大 27 個までサポートできます。 

![分散型可用性グループ](media/sql-server-ha-story/image11.png)

SQL Server 2017 から、None のクラスターの種類で構成されている可用性グループを使用して、ほぼリアルタイムの読み取り専用ソリューションを作成できます。 目的が可用性グループを読み取り可能なセカンダリ レプリカに使用することで、可用性ではない場合は、これを行うことで WSFC または Pacemaker を使用することの複雑さが解消され、より簡単な展開方法で可用性グループの読み取り可能の利点が得られます。 

主な注意点は、クラスターの種類が None の基になるクラスターがないため、読み取り専用ルーティングの構成が少し異なることだけです。 SQL Server の観点からは、クラスターが存在しない場合でも、要求をルーティングするために引き続きリスナーが必要です。 従来のリスナーを構成する代わりに、IP アドレスまたはプライマリ レプリカの名前が使用されます。 プライマリ レプリカは、読み取り専用の要求をルーティングするために使用されます。

ログ配布のウォーム スタンバイは、データベース WITH STANDBY を復元することで読み取り可能な使用量に対して技術的に構成できます。 しかし、トランザクション ログは復元するためのデータベースを排他的に使用する必要があるため、その間はユーザーがデータベースにアクセスできないことを意味します。 これにより、ログ配布が理想的とは言えないソリューションになります。ほぼリアルタイムのデータが必要な場合には特にそうなります。 

可用性グループを使用したすべての読み取りスケールのシナリオで注意すべきことは、すべてのデータがライブであるトランザクション レプリケーションを使用する場合とは異なり、各セカンダリ レプリカは、一意のインデックスを適用できる状態になく、そのレプリカはプライマリの完全なコピーであることです。 これは、レポートに任意のインデックスが必要な場合やデータを操作する必要がある場合は、プライマリ レプリカ上のデータベースで行う必要があることを意味します。 その柔軟性が必要な場合は、レプリケーションが読み取り可能なデータにより適したソリューションです。

## <a name="summary"></a>[概要]

SQL Server 2017 のインスタンスとデータベースは、同じ機能を使用して Windows Server と Linux の両方で高可用性にすることができます。 ローカルの高可用性とディザスター リカバリーの標準的な可用性シナリオの他に、SQL Server の可用性機能を使用することで、アップグレードと移行に伴うダウンタイムを最小限に抑えることができます。 可用性グループは、同じアーキテクチャの一部としてデータベースの追加のコピーを提供して、読み取り可能なコピーをスケール アウトすることもできます。 SQL Server 2017 を使用して、新しいソリューションを展開する場合でも、またはアップグレードを検討している場合でも、SQL Server 2017 には必要とする可用性と信頼性が備わってます。
 
[SimpleAG]:media\sql-server-ha-story\image1.png
[SSMSAGOptions]:media\sql-server-ha-story\image2.png
[BasicFCI]:media\sql-server-ha-story\image3.png
[PostFailoverFCI]:media\sql-server-ha-story\image4.png
[LogShipping]:media\sql-server-ha-story\image5.png
[AG]:media\sql-server-ha-story\image6.png
[DAG]:media\sql-server-ha-story\image7.png
[AlwaysOnFCI]:media\sql-server-ha-story\image8.png
[BasicDAG]:media\sql-server-ha-story\image9.png
[image10]:media\sql-server-ha-story\image10.png
[DAG]:media\sql-server-ha-story\image11.png
